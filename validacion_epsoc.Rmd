---
title: "Validación EPSOC"
author: "Cristóbal Moya"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    number_sections: true
---

# Introducción

Este documento consiste en una revisión del proceso de validación de EPSOC 2018. Se trata de un documento reproducible y dinámico que será actualizado cada vez que haya una nueva entrega de datos durante el trabajo de campo. El código está inserto dentro del documento, pero replegado. Para verlo hacer click en cuadro `code`.

# Preámbulo

Se cargan los datos en el formato entregado y se homogeneiza el formato en minúscula y usando puntos ("`.`") para separar en vez de guiones bajos ("`_`").

```{r cargar}
pacman::p_load(haven, dplyr, purrr, chron, validate, eeptools, kableExtra, 
               captioner, ggplot2, lubridate)
path <- "C:/Users/CM/Dropbox/2016 - Mecanismos de legitimación de la desigualdad/EPSOC/datos/"
epsoc <- read_spss(paste0(path,"181029 - Base EPSOC parcial 1.sav"))
names(epsoc) <- tolower(gsub("_", ".", names(epsoc)))
```

```{r etiquetas}
makeVlist <- function(dta) { 
        labels <- sapply(dta, function(x) attr(x, "label"))
        tibble(name = names(labels),
               label = labels)
}  ## Etiquetas variables
labs.epsoc <- makeVlist(epsoc)
labs.epsoc <- labs.epsoc %>% 
                        mutate(label2 = map_chr(label, toString))
```

# Experimentos

EPSOC contiene dos experimentos que constituyen un foco de análisis del instrumento. El primer experimento consiste en un diseño factorial a través viñetas. El segundo se trata de una aleatorización del orden de preguntas sobre recompensa percibida y justa para tres objetos de evaluación: un obrero, un presidente de empresa y el respondente. Actualmente no es posible validar estos experimento por falta de información.

## Viñetas

Para validar el proceso con las viñetas necesitamos:

- Una breve explicación de cómo está codificado el experimento de las viñetas en la base de datos
- La base de datos que asocia los folios con sets de viñeta en orden presentado
- Acceso a grabaciones de voz durante el proceso de entrevista para asegurarnos que están bien asociadas las escalas con las variables

### Duración ejercicio

- Los marcadores de tiempo `time2` y `time3` no siguen un formato homogéneo para registrar la hora. Por ejemplo, en algún caso se utiliza el formato "2018-10-27T19:05:08-03:00" y en otros "Fri Oct 19 13:01:59 -0300 2018"
- Homogeneizar formatos de tiempos y fechas a ISO8601


```{r dura.vineta, warning=F}
## Comienzo viñetas
epsoc$time2 <- ifelse(nchar(epsoc$time2) == 30, 
                      as.character(strptime(epsoc$time2,
                              format = "%a %b %d %H:%M:%S %z %Y")), 
                      as.character(ymd_hms(epsoc$time2)-hours(3)))
epsoc$time2 <- as_datetime(epsoc$time2)
epsoc$time2.hms <- format(epsoc$time2, format = "%H:%M:%S")
epsoc$time2.hms <- as.POSIXct(epsoc$time2.hms, format = "%H:%M:%S")
epsoc$time2.dmy <- dmy(format(epsoc$time2, format = "%d-%m-%y"))

## Fin viñetas
epsoc$time3 <- ifelse(nchar(epsoc$time3) == 30, 
                      as.character(strptime(epsoc$time3,
                                            format = "%a %b %d %H:%M:%S %z %Y")), 
                      as.character(ymd_hms(epsoc$time3)-hours(3)))
epsoc$time3 <- as_datetime(epsoc$time3)
epsoc$time3.hms <- format(epsoc$time3, format = "%H:%M:%S")
epsoc$time3.hms <- as.POSIXct(epsoc$time3.hms, format = "%H:%M:%S")
epsoc$time3.dmy <- dmy(format(epsoc$time3, format = "%d-%m-%y"))

epsoc$dura.vinetas <- difftime(epsoc$time3, epsoc$time2,
                               units = "mins")
ggplot(epsoc, aes(x = time2.dmy, y = time2.hms)) + geom_point() +
        labs(x = "Día", y = "Hora") + 
        ggtitle("Día y hora comienzo actividad viñetas") + 
        theme_bw()

```


```{r plot.dura, message = F}
epsoc %>% 
        mutate(vin.cort = ifelse(dura.vinetas < 5, "< 5'", ">= 5'")) %>% 
        ggplot(aes(dura.vinetas)) + 
                geom_histogram(aes(fill = vin.cort)) + theme_bw() +
                theme(legend.title=element_blank()) +
                ggtitle("Duración ejercicio viñetas") +
                xlab("Minutos")
```

Como se puede ver en la figura anterior, la distribución del tiempo de duración del ejercicio de viñetas es variable. En términos de validación, llama la atención que se logre realizar el ejercicio en menos de cinco minutos. Estos casos deberían ser revisados apenas sea posible.

## Evaluación de justicia

Para validar el experimento de evaluación de justicia necesitamos:
- Una breve explicación de cómo están codificados los items de recompensa percibida y recompensa justa para un obrero, el presidente de una empresa y el respondente
- Es fundamental saber cuál es la variable que define el orden en que se presentó una y otra pregunta

# Items justicia

La encuesta considera una serie de preguntas con escalas predefinidas. A continuación se revisa que los ítems sobre justicia tengan respuestas en el rango de 1 a 5 o bien valores de 8 o 9.

```{r}
item.just <- flatten_chr(labs.epsoc[grep("usto", labs.epsoc$label2),1])
v <- validator(j := var_group(i.6.a1, i.8.a1, i.9.a1,  i.10.a1, i.11.a1, i.12.a1,
                              i.13.a1, i.16.a1, i.1.h1, i.2.h1, i.5.h1, i.7.h1, 
                              i.8.h1, i.10.h1, i.11.h1, i.12.h1, i.14.h1), 
               j >= 1,
               j <= 9,
               j != 6,
               j != 7)
cf2 <- confront(epsoc, v)
s.cf2 <- summary(cf2)
knitr::kable(s.cf2) %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F)
```

Existen `r length(s.cf2$fails[s.cf2$fails > 0])` variables de actitudes sobre justicia fuera de rango.


# Otros criterios generales

Para validar los datos consideramos los siguientes criterios:  

- El rango etario de la población (18 a 59 años)
- Una duración de menos de dos horas
- Una duración de más de quince minutos
- Las variables con información redundante deben converger (edad y sexo)

```{r}
epsoc$duration <- chron(times=epsoc$duration)
cf <- check_that(epsoc, edad.seleccionado <= 59 & edad.seleccionado >= 18,
                 duration < "02:00:00",
                 duration > "00:15:00",
                 sexo.enc == sexo.seleccionado)
s.cf <- summary(cf)
knitr::kable(s.cf) %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F)
```


Resultados:

- `r ifelse(s.cf$fails[grep("edad", s.cf$expression)] == 0, 
       "No existen respondentes",
       paste("Existen", s.cf$fails[grep("edad", s.cf$expression)], "respondentes"))` fuera del rango etario.
- `r ifelse(s.cf$fails[grep("durat.*<", s.cf$expression)] == 0, 
       "No existen entrevistas",
       paste("Existen", s.cf$fails[grep("durat.*<", s.cf$expression)], "entrevistas"))` que duraron más de dos horas. Debe revisarse la variable `duration` porque el formato de importación no es estándar ya que algunas duran más de un día. Por ejemplo, una entrevista de 42 horas y 10 minutos queda registrada como `1.18:10:00`.
- `r ifelse(s.cf$fails[grep("durat.*>", s.cf$expression)] == 0, 
       "No existen entrevistas",
       paste("Existen", s.cf$fails[grep("durat.*>", s.cf$expression)], "entrevistas"))` que duraron menos de quince minutos. Debe revisarse la variable `duration` porque el formato de importación no es estándar ya que algunas duran más de un día. Por ejemplo, una entrevista de 42 horas y 10 minutos queda registrada como `1.18:10:00`.
- `r ifelse(s.cf$fails[grep("sexo", s.cf$expression)] == 0, 
       "No existen divergencias",
       paste("Existen", s.cf$fails[grep("sexo", s.cf$expression)], "divergencias"))` respecto al sexo del encuestado al comparar la variable `sexo.enc` y `sexo.seleccionado`.         

Las entrevistas que duran más de dos horas corresponden a los folios:

```{r entr.largas}
knitr::kable(cbind(epsoc$folio[epsoc$duration > "02:00:00"],
                as.character(epsoc$duration[epsoc$duration > "02:00:00"])), 
             col.names = c("Folio", "Duración"),
             caption = "Entrevistas de más de dos horas") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F) %>% 
        column_spec(1, width = "10em") %>% 
        column_spec(2, width = "10em")

```

Las entrevistas que duran menos de quince minutos corresponden a los folios:

```{r entr.cortas}
knitr::kable(cbind(epsoc$folio[epsoc$duration < "00:15:00"],
                as.character(epsoc$duration[epsoc$duration < "00:15:00"])), 
             col.names = c("Folio", "Duración"),
             caption = "Entrevistas de menos de quince minutos") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F) %>% 
        column_spec(1, width = "10em") %>% 
        column_spec(2, width = "10em")
```



```{r edad}
## Fecha de nacimiento y edad seleccionado
epsoc$enc.edad[as.character(epsoc$enc.edad) == "1582-10-14"] <- NA # comportamiento extraño al importar desde SPSS
edad <- tibble(Folio = epsoc$folio[is.na(epsoc$enc.edad)],
        Fecha = epsoc$enc.edad[is.na(epsoc$enc.edad)],
        Edad = epsoc$edad.seleccionado[is.na(epsoc$enc.edad)]) 
knitr::kable(edad,
             caption = "Casos sin fecha de nacimiento en `enc_edad`",
             col.names = c("Folio", "Fecha nacimiento", "Edad")) %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F)
```

```{r sexo}
knitr::kable(cbind(epsoc$folio[epsoc$sexo.enc != epsoc$sexo.seleccionado],
                epsoc$sexo.enc[epsoc$sexo.enc != epsoc$sexo.seleccionado],
                epsoc$sexo.seleccionado[epsoc$sexo.enc != epsoc$sexo.seleccionado]), 
             col.names = c("Folio", "sexo.enc", "sexo.seleccionado"),
             caption = "Entrevistas donde sexo encuestado y seleccionado no coinciden") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                      full_width=F)

```

