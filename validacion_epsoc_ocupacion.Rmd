---
title: | 
  | Validación EPSOC
  | Preguntas de cadena
author: "Equipo EPSOC"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    number_sections: true
---

# Codificación de datos

El proceso de codificación de preguntas abiertas es trabajo-intensivo y consiste en asignar códigos preespecificados a las respuestas a preguntas abiertas entregadas por los entrevistados.

DESUC codificará la variable “*ocupación/oficio*” de acuerdo al código `CIUO 2008` y la variable “*rama de actividad económica*” de acuerdo al código `CIIU Rev4`. La codificación de ocupación se realizará a 4 dígitos, mientras que la codificación de rama económica se realizará a 2 dígitos.

Para esta tarea DESUC cuenta con codificadores y supervisores altamente calificados a los que se pide una doble codificación de las respuestas para revisar la confiabilidad a través de chequeos entre pares. Luego de una limpieza general de los registros, este trabajo se realizará manualmente en dependencias de DESUC.

DESUC también dará uniformidad a la denominación de las variables nominales incluyendo los siguientes criterios de estandarización para las respuestas a preguntas abiertas sugeridos en los TdR:

1. Se pasarán todos los textos a minúscula.
2. La misma palabra en masculino o femenino debe ser considerada como una sola. categoría, por ejemplo, profesor o profesora, debe estar en una categoría profesor(a).
3. Eliminar los espacios en blanco entre palabras o letras según corresponde.
4. Eliminar las faltas de ortografías.

La tarea de limpieza y uniformización de estas variables se realizará asistido por un paquete de R especializado en análisis cuantitativo de texto.

Al finalizar el proceso, DESUC elaborará una minuta con los resultados del proceso de codificación de datos, el personal que participó en la codificación, los mecanismos de control de calidad y los resultados del proceso de codificación.

> Entrega 5.1: Minuta Procesamiento de Datos (formato DOCX).

```{r setup}
pacman::p_load(lubridate, anytime, chron,
               sjlabelled, sjmisc, janitor,
               validate, naniar,
               haven, kableExtra, here, 
               tidyverse)

epsoc <-haven::read_spss('../EPSOC Base parcial con vinetas.sav')
```

```{r funciones}
kable_estilo <- function(tabla){
  tabla %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                              full_width=F)
}
```


# Ocupación/oficio

Para el trabajo con las preguntas de ocupación y oficio se prepara una base especial para el equipo codificador. En ella, aparte de las preguntas a codificar se agrega información adicional útil para distinguir entre distintos códigos.


## Nivel educacional

```{r}
frq(epsoc, f1)
```


## Actividad principal durante el último mes

```{r}
frq(epsoc$f2)
```

## Autopercepción de clase social

```{r}
frq(epsoc$f16)
```

Cruce entre autopercepción de clases social y barrio en el que vive

```{r}
flat_table(epsoc, f16, f17, margin = 'cell')
```

```{r}
frq(epsoc, f21)
```


# Base de datos

Se separan las variables de interés para la calificación de la ocupación (`f3`) y la rama de actividad económica (`f4`).

```{r}
df_ocupaciones <- epsoc %>% 
  select(folio, 
         edad.seleccionado, sexo.seleccionado, situacion.laboral.seleccionado,
         estrato,
         f1, f2,
         f3a, # ¿Cuál es su ocupación u oficio en su trabajo?
         f3b, # ¿Cuál era su ocupación u oficio en su último trabajo?
         f4a, # ¿A qué rubro o giro de actividad se dedica principalmente la empresa, institución o negocio para el cual trabaja? 
         f4b, # ¿A qué rubro o giro de actividad se dedicaba principalmente la empresa, institución o negocio para el cual trabajaba? 
         f5a, # ¿Cuántas personas trabajan en la empresa, institución o negocio donde usted trabaja?
         f5b,
         f7a, # En su trabajo o negocio principal, ¿usted trabaja como?
         f7b,
         f12, # ¿Cotizó durante el mes pasado en algún sistema previsional (sistema de pensiones)?
         f16, # ¿Con cuál de estos grupos (clases sociales) se identifica más usted?
         f17,
         f22
  )

df_ocupaciones <- df_ocupaciones %>% 
  mutate_if(is.character, 
            ~str_squish(.) %>% str_to_lower())

df_ocupaciones <- copy_labels(df_ocupaciones, 
                              epsoc)

glimpse(df_ocupaciones)
```

# Grabación de datos

```{r}
nombres <- str_c(names(df_ocupaciones), get_label(df_ocupaciones), sep = ' - ')

get_label(epsoc$f3a)

# Grabar Excel
df_ocupaciones %>% 
  mutate_all(to_label) %>% 
  rename_all(~nombres) %>% 
  writexl::write_xlsx('ocupaciones/epsoc_ocupaciones_as_label.xlsx')

# Grabar SPSS
df_ocupaciones %>%
  write_sav('ocupaciones/epsoc_ocupaciones.sav')
```





